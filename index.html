<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Pollination – التلقيح الذكي</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Styles -->
    <style>
      :root {
        --forest: #1c5634;
        --forest-dark: #153f27;
        --sand: #f5f0e6;
        --accent: #2f7a4a;
        --text: #213029;
        --muted: #6f7d73;
        --card-radius: 20px;
        --shadow: 0 24px 56px rgba(28, 86, 52, 0.16);
        --transition: 0.32s ease;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        font-family: 'Roboto', 'Tajawal', sans-serif;
        background: var(--sand);
        color: var(--text);
        min-height: 100%;
      }

      body.rtl {
        direction: rtl;
        font-family: 'Tajawal', 'Roboto', sans-serif;
      }

      body.modal-open {
        overflow: hidden;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(160deg, rgba(28, 86, 52, 0.06), transparent 65%);
      }

      header.top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px clamp(16px, 4vw, 40px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        font-weight: 600;
        color: var(--forest);
        letter-spacing: 0.05em;
      }

      .brand-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: rgba(28, 86, 52, 0.12);
        font-size: 22px;
      }

      main {
        flex: 1;
        display: flex;
        justify-content: center;
        padding: clamp(24px, 4vw, 56px) clamp(16px, 4vw, 48px);
      }

      .page {
        display: none;
        width: min(980px, 100%);
        background: rgba(255, 255, 255, 0.82);
        backdrop-filter: blur(18px);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow);
        padding: clamp(32px, 5vw, 60px);
      }

      .page.active {
        display: flex;
        flex-direction: column;
        gap: clamp(24px, 4vw, 40px);
      }

      .page.language {
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: calc(100vh - 160px);
      }

      h1 {
        margin: 0;
        font-size: clamp(2.3rem, 4vw, 3.1rem);
        color: var(--forest);
      }

      p {
        margin: 0;
        line-height: 1.6;
        color: var(--muted);
        font-size: 1rem;
      }

      .section-heading {
        font-weight: 600;
        color: var(--forest);
        font-size: 1.1rem;
      }

      .language-options {
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .btn {
        border: none;
        border-radius: 16px;
        padding: 16px 32px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .btn-primary {
        background: var(--forest);
        color: #fff;
        box-shadow: 0 12px 32px rgba(28, 86, 52, 0.24);
      }

      .btn-secondary {
        background: rgba(28, 86, 52, 0.12);
        color: var(--forest);
        box-shadow: inset 0 0 0 1px rgba(28, 86, 52, 0.22);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn:not(:disabled):hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 34px rgba(28, 86, 52, 0.26);
      }

      .hint-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
      }

      .hint-card {
        background: #fff;
        border-radius: var(--card-radius);
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: inset 0 0 0 1px rgba(28, 86, 52, 0.06);
      }

      .hint-icon {
        font-size: 28px;
      }

      .control-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
      }

      #analyzeBtn {
        margin-left: auto;
      }

      body.rtl #analyzeBtn {
        margin-left: 0;
        margin-right: auto;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .viewer-card,
      .result-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--card-radius);
        padding: clamp(20px, 3vw, 28px);
        box-shadow: inset 0 0 0 1px rgba(28, 86, 52, 0.08);
        min-height: clamp(280px, 42vw, 420px);
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .viewer-surface {
        flex: 1;
        border-radius: 18px;
        background: #fff;
        border: 2px solid rgba(28, 86, 52, 0.18);
        box-shadow: 0 18px 40px rgba(28, 86, 52, 0.14);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        outline: none;
      }

      .viewer-surface:focus-visible {
        box-shadow: 0 0 0 3px rgba(47, 122, 74, 0.35);
      }

      .viewer-placeholder {
        color: var(--muted);
        font-weight: 500;
        text-align: center;
        padding: 24px;
      }

      .viewer-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
      }

      .viewer-img.visible {
        display: block;
      }

      .result-card {
        justify-content: center;
      }

      .loading-state {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .spinner {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 4px solid rgba(28, 86, 52, 0.2);
        border-top-color: var(--forest);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .analysis-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .analysis-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .analysis-label {
        font-size: 0.9rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .analysis-value {
        font-weight: 600;
        color: var(--forest-dark);
      }

      .confidence-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(28, 86, 52, 0.15);
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--forest), var(--accent));
        transition: width 0.6s ease;
      }

      .action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-start;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(12, 32, 22, 0.35);
        backdrop-filter: blur(6px);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        padding: clamp(18px, 6vw, 48px);
        z-index: 40;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background: rgba(255, 255, 255, 0.96);
        border-radius: 28px;
        width: min(720px, 100%);
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: clamp(24px, 4vw, 38px);
        box-shadow: 0 32px 64px rgba(28, 86, 52, 0.2);
        max-height: calc(100vh - clamp(36px, 12vw, 96px));
        overflow-y: auto;
        overscroll-behavior: contain;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .thumb-card {
        border: none;
        border-radius: 18px;
        background: #fff;
        overflow: hidden;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        border: 2px solid transparent;
        transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
      }

      .thumb-card img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
      }

      .thumb-card span {
        padding: 12px 16px;
        font-weight: 500;
        color: var(--forest-dark);
      }

      .thumb-card:hover {
        transform: translateY(-4px);
        border-color: var(--forest);
        box-shadow: 0 18px 34px rgba(28, 86, 52, 0.18);
      }

      .thumb-fallback {
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-weight: 500;
        padding: 12px;
        text-align: center;
      }

      .fade {
        opacity: 0;
        transform: translateY(10px);
        transition: opacity var(--transition), transform var(--transition);
      }

      .fade.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .viewer-card,
        .result-card {
          min-height: 280px;
        }
      }

      @media (max-width: 720px) {
        header.top-bar {
          padding: 16px 20px;
        }

        .page {
          padding: clamp(24px, 6vw, 32px);
        }

        .page.language {
          min-height: calc(100vh - 140px);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="top-bar">
        <div class="brand">
          <span class="brand-badge">🌿</span>
          <span id="brandTitle">Smart Pollination – التلقيح الذكي</span>
        </div>
        <button id="resetDemo" class="btn btn-secondary hidden">Reset Demo</button>
      </header>
      <main>
        <!-- Landing & Language Logic -->
        <section id="language-page" class="page language active">
          <h1 data-i18n="appTitleLanding">Smart Pollination – التلقيح الذكي</h1>
          <p class="section-heading" data-i18n="languageSubtitle">
            Choose your preferred language to get started.
          </p>
          <div class="language-options">
            <button class="btn btn-primary" data-lang="en" data-i18n="english">English</button>
            <button class="btn btn-secondary" data-lang="ar" data-i18n="arabic">العربية</button>
          </div>
        </section>

        <section id="info-page" class="page">
          <h1 data-i18n="appTitle">Smart Pollination</h1>
          <p data-i18n-html="introParagraph">
            This tool helps farmers identify the best time for date palm pollination using AI-based
            image analysis.<br />For this demo, results are simulated for exhibition purposes.
          </p>
          <div>
            <div class="section-heading" data-i18n="hintsTitle">How it works</div>
            <div class="hint-grid">
              <div class="hint-card">
                <span class="hint-icon">📸</span>
                <span data-i18n="h1">Upload or select a flower image</span>
              </div>
              <div class="hint-card">
                <span class="hint-icon">🧠</span>
                <span data-i18n="h2">AI analyzes readiness for pollination</span>
              </div>
              <div class="hint-card">
                <span class="hint-icon">🌴</span>
                <span data-i18n="h3">Get timing advice and success prediction</span>
              </div>
            </div>
          </div>
          <div class="action-row">
            <button id="startDemo" class="btn btn-primary" data-i18n="startDemo">Start Demo</button>
          </div>
        </section>

        <!-- Main Grid Layout -->
        <section id="analysis-page" class="page">
          <h1 data-i18n="appTitle">Smart Pollination</h1>
          <div class="control-bar">
            <button id="imagePickerBtn" class="btn btn-secondary" data-i18n="chooseImage">
              Choose Sample Image
            </button>
            <button id="analyzeBtn" class="btn btn-primary" data-i18n="analyze" disabled>
              Analyze
            </button>
          </div>
          <div class="main-grid">
            <div class="viewer-card">
              <div
                class="viewer-surface"
                id="imageViewer"
                role="button"
                tabindex="0"
                aria-label="Open image picker"
              >
                <div class="viewer-placeholder" data-i18n="viewerPlaceholder">
                  Select an image to preview it here.
                </div>
                <img id="mainImage" class="viewer-img" alt="" />
              </div>
            </div>
            <div class="result-card">
              <div id="loadingState" class="loading-state hidden">
                <div class="spinner" aria-hidden="true"></div>
                <div class="analysis-value" data-i18n="analyzing">Analyzing image…</div>
              </div>
              <div id="analysisContent" class="analysis-content hidden fade">
                <div class="analysis-row">
                  <span class="analysis-label" data-i18n="stage">Stage</span>
                  <span class="analysis-value" id="resultStage">—</span>
                </div>
                <div class="analysis-row">
                  <span class="analysis-label" data-i18n="status">Status</span>
                  <span class="analysis-value" id="resultStatus">—</span>
                </div>
                <div class="analysis-row">
                  <span class="analysis-label" data-i18n="recommendation">Recommendation</span>
                  <span class="analysis-value" id="resultRecommendation">—</span>
                </div>
                <div class="analysis-row">
                  <span class="analysis-label" data-i18n="successRate">Expected success rate</span>
                  <span class="analysis-value" id="resultSuccess">—</span>
                  <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="analysis-value" data-i18n="modalTitle">Select a sample image</h3>
          <button id="modalCloseBtn" class="btn btn-secondary" data-i18n="modalClose">Close</button>
        </div>
        <div id="modalGrid" class="modal-grid"></div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // <!-- Strings & Data -->
      const STRINGS = {
        en: {
          appTitleLanding: 'Smart Pollination – التلقيح الذكي',
          appTitle: 'Smart Pollination',
          chooseImage: 'Choose Sample Image',
          analyze: 'Analyze',
          analyzing: 'Analyzing image…',
          successRate: 'Expected success rate',
          recommendation: 'Recommendation',
          stage: 'Stage',
          status: 'Status',
          modalTitle: 'Select a sample image',
          modalClose: 'Close',
          startDemo: 'Start Demo',
          reset: 'Reset Demo',
          notFound: 'Image not found',
          demoStatus: 'Demo mode',
          demoRecommendation:
            'Sample-only analysis. Please use one of the listed images for predefined results.',
          demoSuccess: '—',
          languageSubtitle: 'Choose your preferred language to get started.',
          english: 'English',
          arabic: 'العربية',
          hintsTitle: 'How it works',
          h1: 'Upload or select a flower image',
          h2: 'AI analyzes readiness for pollination',
          h3: 'Get timing advice and success prediction',
          introParagraph:
            'This tool helps farmers identify the best time for date palm pollination using AI-based image analysis.<br />For this demo, results are simulated for exhibition purposes.',
          viewerPlaceholder: 'Select an image to preview it here.'
        },
        ar: {
          appTitleLanding: 'Smart Pollination – التلقيح الذكي',
          appTitle: 'التلقيح الذكي',
          chooseImage: 'اختر صورة من القائمة',
          analyze: 'تحليل',
          analyzing: 'جاري تحليل الصورة…',
          successRate: 'نسبة النجاح المتوقعة',
          recommendation: 'التوصية',
          stage: 'المرحلة',
          status: 'الحالة',
          modalTitle: 'اختر صورة تجريبية',
          modalClose: 'إغلاق',
          startDemo: 'ابدأ العرض',
          reset: 'إعادة التهيئة',
          notFound: 'تعذّر تحميل الصورة',
          demoStatus: 'وضع العرض',
          demoRecommendation:
            'تحليل تجريبي فقط. استخدم إحدى الصور المدرجة لنتائج محددة مسبقًا.',
          demoSuccess: '—',
          languageSubtitle: 'اختر لغتك المفضلة للمتابعة.',
          english: 'English',
          arabic: 'العربية',
          hintsTitle: 'كيف يعمل',
          h1: 'ارفع أو اختر صورة للزهرة',
          h2: 'يحلل الذكاء الاصطناعي جاهزية التلقيح',
          h3: 'احصل على نصائح وتوقع نسبة النجاح',
          introParagraph:
            'يساعد هذا النظام المزارعين على تحديد أفضل وقت لتلقيح نخيل التمر باستخدام تحليل صور مدعوم بالذكاء الاصطناعي.<br />في هذا العرض، النتائج وهمية لأغراض المعرض فقط.',
          viewerPlaceholder: 'اختر صورة لعرضها هنا.'
        }
      };

      const ANALYSIS_DB = {
        '00003.jpg': {
          en: {
            stage: 'Very early (pre-anthesis)',
            status: 'Not ready yet',
            recommendation: 'Wait 2–3 days before pollination.',
            success: 40,
            tip: 'Monitor daily until flowers open fully.'
          },
          ar: {
            stage: 'مبكرة جدًا (قبل التفتح)',
            status: 'غير جاهزة بعد',
            recommendation: 'انتظر 2–3 أيام قبل التلقيح.',
            success: 40,
            tip: 'تابع الملاحظة يوميًا حتى يتفتح الطلع بالكامل.'
          }
        },
        '00006.jpg': {
          en: {
            stage: 'Early to mid',
            status: 'Not ready yet',
            recommendation: 'Wait 1–2 days.',
            success: 55,
            tip: 'الغلاف بدأ ينفتح جزئيًا، استمر بالمراقبة.'
          },
          ar: {
            stage: 'مرحلة مبكرة إلى متوسطة',
            status: 'غير جاهزة بعد',
            recommendation: 'انتظر 1–2 يوم.',
            success: 55,
            tip: 'الغلاف بدأ ينفتح جزئيًا؛ استمر بالمراقبة.'
          }
        },
        '00007.jpg': {
          en: {
            stage: 'Beginning of opening',
            status: 'Almost ready',
            recommendation: 'Re-check within 12 hours.',
            success: 75,
            tip: 'Partial opening; readiness approaching.'
          },
          ar: {
            stage: 'بداية التفتح',
            status: 'قريبة من الجاهزية',
            recommendation: 'أعد الفحص خلال 12 ساعة.',
            success: 75,
            tip: 'تفتح جزئي؛ الجاهزية تقترب.'
          }
        },
        '00002.jpg': {
          en: {
            stage: 'Optimal opening',
            status: 'Ready now ✅',
            recommendation: 'Pollinate now.',
            success: 95,
            tip: 'Apply pollen within the next 6 hours.'
          },
          ar: {
            stage: 'تفتح مثالي',
            status: 'جاهزة الآن ✅',
            recommendation: 'قم بالتلقيح الآن.',
            success: 95,
            tip: 'طبّق اللقاح خلال 6 ساعات.'
          }
        },
        '00008.jpg': {
          en: {
            stage: 'Fully open',
            status: 'Highly ready ✅',
            recommendation: 'Pollinate within 6 hours.',
            success: 90,
            tip: 'Maintain gentle handling to avoid damage.'
          },
          ar: {
            stage: 'متفتحة بالكامل',
            status: 'جاهزية عالية ✅',
            recommendation: 'لقّح خلال 6 ساعات.',
            success: 90,
            tip: 'تعامل بلطف لتجنب تلف الأزهار.'
          }
        },
        '00005.jpg': {
          en: {
            stage: 'Late (post-optimal)',
            status: 'Window closing',
            recommendation: 'Pollination now is less effective.',
            success: 60,
            tip: 'Consider prioritizing other spathes.'
          },
          ar: {
            stage: 'متأخرة (بعد الأفضل)',
            status: 'نافذة التلقيح أوشكت على الإغلاق',
            recommendation: 'التلقيح الآن أقل فاعلية.',
            success: 60,
            tip: 'يفضّل إعطاء الأولوية لطلع آخر.'
          }
        },
        '00001.jpg': {
          en: {
            stage: 'Very late',
            status: 'Too late ❌',
            recommendation: 'Do not pollinate; remove old spathes.',
            success: 25,
            tip: 'Schedule pruning and sanitation.'
          },
          ar: {
            stage: 'متأخرة جدًا',
            status: 'انتهى الوقت ❌',
            recommendation: 'لا تُلقّح؛ قم بإزالة الطلع القديم.',
            success: 25,
            tip: 'رتّب للتقليم والتنظيف.'
          }
        },
        '00004.jpg': {
          en: {
            stage: 'Old/dry',
            status: 'Not suitable ❌',
            recommendation: 'Pollination period ended.',
            success: 10,
            tip: 'Focus on new emerging spathes.'
          },
          ar: {
            stage: 'قديمة/جافة',
            status: 'غير صالحة ❌',
            recommendation: 'انتهت فترة التلقيح.',
            success: 10,
            tip: 'ركّز على الطلع الجديد.'
          }
        }
      };

      const SAMPLE_BASES = ['00001', '00002', '00003', '00004', '00005', '00006', '00007', '00008'];

      // <!-- Element References -->
      const pages = {
        language: document.getElementById('language-page'),
        info: document.getElementById('info-page'),
        analysis: document.getElementById('analysis-page')
      };

      const brandTitle = document.getElementById('brandTitle');
      const resetDemoBtn = document.getElementById('resetDemo');
      const startDemoBtn = document.getElementById('startDemo');
      const imagePickerBtn = document.getElementById('imagePickerBtn');
      const imageModal = document.getElementById('imageModal');
      const modalGrid = document.getElementById('modalGrid');
      const modalCloseBtn = document.getElementById('modalCloseBtn');
      const viewerSurface = document.getElementById('imageViewer');
      const viewerPlaceholder = viewerSurface.querySelector('.viewer-placeholder');
      const viewerImage = document.getElementById('mainImage');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const loadingState = document.getElementById('loadingState');
      const analysisContent = document.getElementById('analysisContent');
      const confidenceFill = document.getElementById('confidenceFill');
      const resultStage = document.getElementById('resultStage');
      const resultStatus = document.getElementById('resultStatus');
      const resultRecommendation = document.getElementById('resultRecommendation');
      const resultSuccess = document.getElementById('resultSuccess');

      let currentLanguage = localStorage.getItem('lang') || 'en';
      let currentSampleKey = '';
      let currentSampleUrl = '';
      let pendingTimer = null;
      let lastAnalysis = null;
      const imageCache = new Map();

      document.addEventListener('DOMContentLoaded', async () => {
        await buildImagePicker();
        attachEventListeners();
        applyLanguage(currentLanguage);

        showPage('language');
      });

      function attachEventListeners() {
        document.querySelectorAll('[data-lang]').forEach((button) => {
          button.addEventListener('click', () => {
            setLanguage(button.dataset.lang);
            showPage('info');
          });
        });

        startDemoBtn.addEventListener('click', () => showPage('analysis'));
        imagePickerBtn.addEventListener('click', openImageModal);
        modalCloseBtn.addEventListener('click', closeImageModal);
        modalGrid.addEventListener('click', handleThumbnailClick);
        imageModal.addEventListener('click', (event) => {
          if (event.target === imageModal) {
            closeImageModal();
          }
        });

        viewerSurface.addEventListener('click', openImageModal);
        viewerSurface.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openImageModal();
          }
        });

        analyzeBtn.addEventListener('click', handleAnalyze);

        resetDemoBtn.addEventListener('click', () => {
          clearPendingAnalysis();
          currentSampleKey = '';
          currentSampleUrl = '';
          lastAnalysis = null;
          analyzeBtn.disabled = true;
          renderPlaceholder();
          hideWithFade(analysisContent, true);
          hideWithFade(loadingState, true);
          localStorage.removeItem('lang');
          setLanguage('en');
          showPage('language');
        });
      }

      // <!-- Language Logic -->
      function setLanguage(lang) {
        if (!STRINGS[lang]) return;
        currentLanguage = lang;
        localStorage.setItem('lang', lang);
        applyLanguage(lang);
      }

      function applyLanguage(lang) {
        const dict = STRINGS[lang] || STRINGS.en;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        document.body.classList.toggle('rtl', lang === 'ar');

        document.querySelectorAll('[data-i18n]').forEach((node) => {
          const key = node.dataset.i18n;
          if (dict[key]) {
            node.innerText = dict[key];
          }
        });

        document.querySelectorAll('[data-i18n-html]').forEach((node) => {
          const key = node.dataset.i18nHtml;
          if (dict[key]) {
            node.innerHTML = dict[key];
          }
        });

        document.title = dict.appTitleLanding;
        updateHeaderTitle();
        updateModalTexts();
        renderPlaceholder();
        updateAnalysisText();
      }

      function showPage(pageKey) {
        Object.entries(pages).forEach(([key, page]) => {
          page.classList.toggle('active', key === pageKey);
        });
        resetDemoBtn.classList.toggle('hidden', pageKey === 'language');
        updateHeaderTitle();
        const prefersReducedMotion =
          window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        window.requestAnimationFrame(() => {
          window.scrollTo({ top: 0, behavior: prefersReducedMotion ? 'auto' : 'smooth' });
        });
      }

      function updateHeaderTitle() {
        const dict = STRINGS[currentLanguage] || STRINGS.en;
        const isLandingActive = pages.language.classList.contains('active');
        brandTitle.innerText = isLandingActive ? dict.appTitleLanding : dict.appTitle;
        resetDemoBtn.innerText = dict.reset;
      }

      // <!-- Image Loader -->
      async function resolveImageUrl(base) {
        if (imageCache.has(base)) {
          const rawPath = imageCache.get(base);
          return `${rawPath}?v=${Date.now()}`;
        }
        const exts = ['.jpg', '.jpeg', '.png'];
        for (const ext of exts) {
          const rawPath = `./images/${base}${ext}`;
          const cacheBust = Date.now();
          const testUrl = `${rawPath}?v=${cacheBust}`;
          try {
            await new Promise((res, rej) => {
              const test = new Image();
              test.onload = () => res();
              test.onerror = () => rej(testUrl);
              test.src = testUrl;
            });
            imageCache.set(base, rawPath);
            return `${rawPath}?v=${cacheBust}`;
          } catch (failedUrl) {
            console.warn('Image failed:', failedUrl);
          }
        }
        return null;
      }

      async function buildImagePicker() {
        modalGrid.innerHTML = '';
        for (const base of SAMPLE_BASES) {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'thumb-card';
          card.dataset.base = base;

          const resolved = await resolveImageUrl(base);
          if (resolved) {
            const img = document.createElement('img');
            img.src = resolved;
            img.alt = `${base}`;
            img.loading = 'lazy';
            card.appendChild(img);
            card.dataset.resolved = resolved;
            card.dataset.filename = resolved.split('?')[0].split('/').pop() || `${base}.jpg`;
          } else {
            const fallback = document.createElement('div');
            fallback.className = 'thumb-fallback';
            fallback.innerText = STRINGS[currentLanguage]?.notFound || STRINGS.en.notFound;
            card.appendChild(fallback);
            card.dataset.resolved = '';
            card.dataset.filename = `${base}.jpg`;
          }

          const label = document.createElement('span');
          label.innerText = base;
          card.appendChild(label);
          modalGrid.appendChild(card);
        }
      }

      function handleThumbnailClick(event) {
        const card = event.target.closest('.thumb-card');
        if (!card) return;
        selectSample(card.dataset.base, card.dataset.resolved, card.dataset.filename);
        closeImageModal();
      }

      // <!-- Modal -->
      function openImageModal() {
        imageModal.classList.add('open');
        document.body.classList.add('modal-open');
      }

      function closeImageModal() {
        imageModal.classList.remove('open');
        document.body.classList.remove('modal-open');
      }

      function updateModalTexts() {
        const dict = STRINGS[currentLanguage] || STRINGS.en;
        document.querySelectorAll('[data-i18n="modalTitle"]').forEach(
          (node) => (node.innerText = dict.modalTitle)
        );
        modalCloseBtn.innerText = dict.modalClose;
        modalGrid.querySelectorAll('.thumb-fallback').forEach((node) => {
          node.innerText = dict.notFound;
        });
      }

      // <!-- Main Grid & Rendering -->
      async function selectSample(base, preResolved = '', preFilename = '') {
        analyzeBtn.disabled = true;
        const dict = STRINGS[currentLanguage] || STRINGS.en;
        let resolved = preResolved;

        if (!resolved) {
          resolved = await resolveImageUrl(base);
        }

        if (resolved) {
          currentSampleUrl = resolved;
          const filename = preFilename || resolved.split('?')[0].split('/').pop();
          currentSampleKey = filename || `${base}.jpg`;
          setViewerImage(resolved, currentSampleKey);
          analyzeBtn.disabled = false;
        } else {
          currentSampleUrl = '';
          currentSampleKey = preFilename || `${base}.jpg`;
          viewerImage.classList.remove('visible');
          viewerImage.classList.add('hidden');
          viewerPlaceholder.innerText = dict.notFound;
          viewerPlaceholder.classList.remove('hidden');
        }

        lastAnalysis = null;
        hideWithFade(analysisContent);
        hideWithFade(loadingState, true);
        confidenceFill.style.width = '0';
      }

      function setViewerImage(url, altText) {
        const dict = STRINGS[currentLanguage] || STRINGS.en;
        viewerPlaceholder.innerText = dict.viewerPlaceholder;
        viewerPlaceholder.classList.remove('hidden');
        viewerImage.classList.remove('visible');
        viewerImage.classList.add('hidden');

        viewerImage.onload = () => {
          viewerPlaceholder.classList.add('hidden');
          viewerImage.classList.remove('hidden');
          viewerImage.classList.add('visible');
        };

        viewerImage.onerror = () => {
          console.warn('Preview failed:', url);
          viewerImage.classList.remove('visible');
          viewerImage.classList.add('hidden');
          viewerPlaceholder.innerText = dict.notFound;
          viewerPlaceholder.classList.remove('hidden');
        };

        viewerImage.alt = altText;
        viewerImage.src = url;
      }

      function renderPlaceholder() {
        if (currentSampleUrl) return;
        const dict = STRINGS[currentLanguage] || STRINGS.en;
        viewerImage.classList.remove('visible');
        viewerImage.classList.add('hidden');
        viewerPlaceholder.innerText = dict.viewerPlaceholder;
        viewerPlaceholder.classList.remove('hidden');
      }

      // <!-- AI Simulation -->
      function handleAnalyze() {
        if (!currentSampleKey) return;
        clearPendingAnalysis();
        analyzeBtn.disabled = true;
        hideWithFade(analysisContent);
        showWithFade(loadingState);

        pendingTimer = window.setTimeout(() => {
          if (ANALYSIS_DB[currentSampleKey]) {
            lastAnalysis = { type: 'sample', key: currentSampleKey };
          } else {
            lastAnalysis = { type: 'unknown' };
          }
          updateAnalysisText();
          hideWithFade(loadingState, true);
          showWithFade(analysisContent);
          analyzeBtn.disabled = false;
          pendingTimer = null;
        }, 2500);
      }

      function updateAnalysisText() {
        if (!lastAnalysis) return;
        const dict = STRINGS[currentLanguage] || STRINGS.en;

        if (lastAnalysis.type === 'sample' && ANALYSIS_DB[lastAnalysis.key]) {
          const entry = ANALYSIS_DB[lastAnalysis.key];
          const data = entry[currentLanguage] || entry.en;
          resultStage.innerText = data.stage;
          resultStatus.innerText = data.status;
          resultRecommendation.innerText = data.recommendation;
          resultSuccess.innerText = `${data.success}%`;
          confidenceFill.style.width = `${data.success}%`;
        } else {
          resultStage.innerText = '—';
          resultStatus.innerText = dict.demoStatus;
          resultRecommendation.innerText = dict.demoRecommendation;
          resultSuccess.innerText = dict.demoSuccess;
          confidenceFill.style.width = '0';
        }
      }

      function clearPendingAnalysis() {
        if (pendingTimer) {
          window.clearTimeout(pendingTimer);
          pendingTimer = null;
        }
        hideWithFade(loadingState, true);
        hideWithFade(analysisContent, true);
        confidenceFill.style.width = '0';
      }

      // <!-- Rendering -->
      function showWithFade(element) {
        element.classList.remove('hidden');
        requestAnimationFrame(() => {
          element.classList.add('visible');
        });
      }

      function hideWithFade(element, immediate = false) {
        if (immediate) {
          element.classList.remove('visible');
          element.classList.add('hidden');
          return;
        }
        if (element.classList.contains('hidden')) {
          element.classList.remove('visible');
          return;
        }
        element.classList.remove('visible');
        const onTransitionEnd = (event) => {
          if (event.target === element) {
            element.classList.add('hidden');
            element.removeEventListener('transitionend', onTransitionEnd);
          }
        };
        element.addEventListener('transitionend', onTransitionEnd);
      }
    </script>
  </body>
</html>
